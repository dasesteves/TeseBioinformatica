-- =====================================================
-- QUERIES PARA DESCOBRIR SÉRIES E CONFIGURAÇÃO
-- Base de dados: PCE (Oracle)
-- =====================================================

-- 1. VERIFICAR SÉRIES USADAS NOS MOVIMENTOS DE STOCK
-- Mostra as séries que estão sendo usadas atualmente
SELECT DISTINCT 
    CDU_CSU_TIPODOCSTK AS TIPO_DOCUMENTO,
    CDU_CSU_SERIESTK AS SERIE,
    CDU_CSU_FILIALSTK AS FILIAL,
    COUNT(*) AS TOTAL_MOVIMENTOS
FROM PCE.CSU_EPENTIDADEACTOS
WHERE CDU_CSU_TIPODOCSTK IS NOT NULL
  AND CDU_CSU_SERIESTK IS NOT NULL
  AND CDU_CSU_DATA >= ADD_MONTHS(SYSDATE, -3) -- Últimos 3 meses
GROUP BY CDU_CSU_TIPODOCSTK, CDU_CSU_SERIESTK, CDU_CSU_FILIALSTK
ORDER BY TOTAL_MOVIMENTOS DESC;

-- 2. EXEMPLOS DE MOVIMENTOS COM SUCESSO (EXPORTADOS)
-- Mostra exemplos de movimentos que foram exportados com sucesso
SELECT 
    CDU_CSU_TIPODOCSTK AS TIPO_DOC,
    CDU_CSU_SERIESTK AS SERIE,
    CDU_CSU_NUMDOCSTK AS NUM_DOC,
    CDU_CSU_FILIALSTK AS FILIAL,
    CDU_CSU_DATA AS DATA_MOVIMENTO,
    CDU_CSU_EXPORTADO AS STATUS_EXPORT,
    CDU_CSU_OBSERVACOES
FROM PCE.CSU_EPENTIDADEACTOS
WHERE CDU_CSU_EXPORTADO = 2 -- 2 = Exportado com sucesso
  AND CDU_CSU_TIPODOCSTK IS NOT NULL
  AND ROWNUM <= 20
ORDER BY CDU_CSU_DATA DESC;

-- 3. VERIFICAR TIPOS DE DOCUMENTOS USADOS
-- Lista todos os tipos de documentos distintos
SELECT DISTINCT
    CDU_CSU_TIPODOCSTK AS TIPO_DOCUMENTO,
    CASE 
        WHEN CDU_CSU_TIPODOCSTK = 'GS' THEN 'Guia de Saída'
        WHEN CDU_CSU_TIPODOCSTK = 'CS' THEN 'Consumo de Stock'
        WHEN CDU_CSU_TIPODOCSTK = 'GT' THEN 'Guia de Transporte'
        WHEN CDU_CSU_TIPODOCSTK = 'MST' THEN 'Movimento de Stock'
        ELSE 'Outro'
    END AS DESCRICAO_PROVAVEL
FROM PCE.CSU_EPENTIDADEACTOS
WHERE CDU_CSU_TIPODOCSTK IS NOT NULL;

-- 4. VERIFICAR ARTIGOS COM CÓDIGO FA
-- Busca movimentos específicos de artigos com prefixo FA
SELECT 
    ea.CDU_CSU_TIPODOCSTK AS TIPO_DOC,
    ea.CDU_CSU_SERIESTK AS SERIE,
    ea.EPISODIO,
    eg.CDU_CSU_ARTIGO AS ARTIGO,
    eg.CDU_CSU_DESCRICAO AS DESCRICAO,
    eg.CDU_CSU_QUANTIDADE AS QUANTIDADE,
    ea.CDU_CSU_DATA AS DATA_MOV
FROM PCE.CSU_EPENTIDADEACTOS ea
JOIN PCE.CSU_EPENTIDADEACTOGASTOS eg 
    ON ea.CDU_CSU_ID = eg.CDU_CSU_EPISODIOENTIDADEACTOID
WHERE eg.CDU_CSU_ARTIGO LIKE 'FA%'
  AND ea.CDU_CSU_TIPODOCSTK IS NOT NULL
  AND ROWNUM <= 50
ORDER BY ea.CDU_CSU_DATA DESC;

-- 5. DESCOBRIR PADRÃO DE SÉRIES POR ANO
-- Verifica se as séries seguem algum padrão anual
SELECT 
    TO_CHAR(CDU_CSU_DATA, 'YYYY') AS ANO,
    CDU_CSU_SERIESTK AS SERIE,
    CDU_CSU_TIPODOCSTK AS TIPO_DOC,
    COUNT(*) AS TOTAL
FROM PCE.CSU_EPENTIDADEACTOS
WHERE CDU_CSU_SERIESTK IS NOT NULL
  AND CDU_CSU_DATA >= TO_DATE('2023-01-01', 'YYYY-MM-DD')
GROUP BY TO_CHAR(CDU_CSU_DATA, 'YYYY'), CDU_CSU_SERIESTK, CDU_CSU_TIPODOCSTK
ORDER BY ANO DESC, TOTAL DESC;

-- 6. VERIFICAR ÚLTIMO MOVIMENTO DO ARTIGO FA10040790
-- Busca especificamente movimentos do artigo em questão
SELECT * FROM (
    SELECT 
        ea.CDU_CSU_TIPODOCSTK AS TIPO_DOC,
        ea.CDU_CSU_SERIESTK AS SERIE,
        ea.CDU_CSU_NUMDOCSTK AS NUM_DOC,
        ea.CDU_CSU_DATA AS DATA_MOV,
        ea.CDU_CSU_EXPORTADO AS STATUS_EXPORT,
        eg.CDU_CSU_QUANTIDADE AS QTD,
        ea.ERRO AS ERRO_EXPORT
    FROM PCE.CSU_EPENTIDADEACTOS ea
    JOIN PCE.CSU_EPENTIDADEACTOGASTOS eg 
        ON ea.CDU_CSU_ID = eg.CDU_CSU_EPISODIOENTIDADEACTOID
    WHERE eg.CDU_CSU_ARTIGO = 'FA10040790'
    ORDER BY ea.CDU_CSU_DATA DESC
) t WHERE ROWNUM <= 10;

-- 7. VERIFICAR CONFIGURAÇÃO DE SERVIÇOS
-- Pode haver configuração específica por serviço
SELECT DISTINCT
    s.SSONHO AS CODIGO_SERVICO,
    s.DSERV AS NOME_SERVICO,
    ea.CDU_CSU_TIPODOCSTK AS TIPO_DOC_USADO,
    ea.CDU_CSU_SERIESTK AS SERIE_USADA
FROM PCE.CSU_EPENTIDADEACTOS ea
JOIN PCE.SERVICO s ON ea.SSONHO = s.SSONHO
WHERE ea.CDU_CSU_TIPODOCSTK IS NOT NULL
  AND ea.CDU_CSU_DATA >= ADD_MONTHS(SYSDATE, -1)
ORDER BY s.SSONHO;

-- 8. VERIFICAR SE HÁ TABELA DE CONFIGURAÇÃO DE SÉRIES
-- Procura tabelas que possam conter configuração de séries
SELECT table_name, comments 
FROM all_tab_comments 
WHERE owner = 'PCE' 
  AND (UPPER(table_name) LIKE '%SERIE%' 
       OR UPPER(table_name) LIKE '%CONFIG%'
       OR UPPER(table_name) LIKE '%PARAMETRO%'
       OR UPPER(comments) LIKE '%SERIE%');

-- 9. ANALISAR PADRÃO DE ERROS
-- Verifica se há padrão nos erros relacionados a séries
SELECT 
    CDU_CSU_TIPODOCSTK AS TIPO_DOC,
    CDU_CSU_SERIESTK AS SERIE,
    CDU_CSU_EXPORTADO AS STATUS,
    ERRO,
    COUNT(*) AS TOTAL_ERROS
FROM PCE.CSU_EPENTIDADEACTOS
WHERE CDU_CSU_EXPORTADO = 9 -- 9 = Erro
  AND ERRO IS NOT NULL
  AND ERRO LIKE '%serie%' -- Erros relacionados com séries
GROUP BY CDU_CSU_TIPODOCSTK, CDU_CSU_SERIESTK, CDU_CSU_EXPORTADO, ERRO
ORDER BY TOTAL_ERROS DESC;

-- 10. VERIFICAR MOVIMENTOS MAIS RECENTES COM SUCESSO
-- Mostra os últimos movimentos bem-sucedidos para entender o padrão atual
SELECT * FROM (
    SELECT 
        CDU_CSU_TIPODOCSTK AS TIPO_DOC,
        CDU_CSU_SERIESTK AS SERIE,
        CDU_CSU_FILIALSTK AS FILIAL,
        TO_CHAR(CDU_CSU_DATA, 'YYYY-MM-DD HH24:MI') AS DATA_HORA,
        CDU_CSU_UTILIZADOR AS USUARIO
    FROM PCE.CSU_EPENTIDADEACTOS
    WHERE CDU_CSU_EXPORTADO = 2
      AND CDU_CSU_TIPODOCSTK IS NOT NULL
      AND CDU_CSU_SERIESTK IS NOT NULL
      AND CDU_CSU_DATA >= SYSDATE - 7 -- Última semana
    ORDER BY CDU_CSU_DATA DESC
) t WHERE ROWNUM <= 20;

-- =====================================================
-- INSTRUÇÕES DE USO:
-- 1. Execute cada query individualmente
-- 2. A Query 1 mostra as séries mais usadas
-- 3. A Query 2 mostra exemplos de sucesso
-- 4. Identifique o padrão e use no script de baixa
-- ===================================================== 